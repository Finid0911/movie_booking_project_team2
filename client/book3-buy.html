<!doctype html>
<html>

<head>
    <!-- Basic Page Needs -->
    <meta charset="utf-8">
    <title>AMovie - Booking step 3</title>
    <meta name="description" content="A Template by Gozha.net">
    <meta name="keywords" content="HTML, CSS, JavaScript">
    <meta name="author" content="Gozha.net">

    <!-- Mobile Specific Metas-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta content="telephone=no" name="format-detection">

    <!-- Fonts -->
    <!-- Font awesome - icon font -->
    <link href="http://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
    <!-- Roboto -->
    <link href='http://fonts.googleapis.com/css?family=Roboto:400,700' rel='stylesheet' type='text/css'>

    <!-- Stylesheets -->

    <!-- Mobile menu -->
    <link href="css/gozha-nav.css" rel="stylesheet" />
    <!-- Select -->
    <link href="css/external/jquery.selectbox.css" rel="stylesheet" />

    <!-- Custom -->
    <link href="css/style.css?v=1" rel="stylesheet" />

    <!-- Modernizr -->
    <script src="js/external/modernizr.custom.js"></script>

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]> 
    	<script src="http://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.js"></script> 
		<script src="http://cdnjs.cloudflare.com/ajax/libs/respond.js/1.3.0/respond.js"></script>		
    <![endif]-->
    <style>
        .header-wrapper {
            height: 55px;
        }

        .header-wrapper .container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 100%;
        }

        .logo {
            position: relative;
            inset: 0;
        }

        .header-user {
            position: relative;
            inset: 0;
            display: flex;
            align-items: center;
            gap: 0 12px;
        }

        .auth--home {
            position: relative;
            inset: 0;
            display: flex;
            align-items: center;

        }

        .btn--singin {
            position: relative !important;
            inset: 0 !important;
        }

        .btn--singin::after {
            top: 7px !important;
        }
    </style>
</head>

<body>
    <div class="wrapper">

        <!-- Header section -->
        <header class="header-wrapper">
            <div class="container">
                <!-- Logo link-->
                <a href='index.html' class="logo">
                    <img alt='logo' src="images/logo.png">
                </a>
                <div class="control-panel header-user">
                    <div class="auth auth--home" id="username">
                        <!-- thay vào đây -->
                    </div>
                    <a href="offers.html" id="show-ticket" class="btn btn-md btn--warning btn--book">Xem vé đã
                        đặt</a>
                </div>

            </div>
        </header>

        <!-- Search bar -->
        <div class="search-wrapper">
            <div class="container container--add">
                <div id='search-form' method='get' class="search" style="top:9px">
                    <input type="text" class="search__field" placeholder="Search" id="search-input">
                    <button id="search-btn" class="btn btn-md btn--danger search__button">search a movie</button>
                </div>
            </div>
        </div>

        <!-- Main content -->
        <section class="container">
            <div class="order-container">
                <div class="order">
                    <img class="order__images" alt='' src="images/tickets.png">
                    <p class="order__title">Book a ticket <br><span class="order__descript">and have fun movie
                            time</span></p>
                    <div class="order__control">
                        <a href="" class="order__control-btn active">Purchase</a>
                    </div>
                </div>
            </div>
            <div class="order-step-area">
                <div class="order-step first--step order-step--disable ">1. What &amp; Where &amp; When</div>
                <div class="order-step second--step order-step--disable">2. Choose a sit</div>
                <div class="order-step third--step">3. Check out</div>
            </div>

            <div class="col-sm-12" id="movie_phong">

            </div>
            <div class="col-sm-12">
                <div class="checkout-wrapper">
                    <h2 class="page-heading">price</h2>
                    <ul class="book-result">
                        <li class="book-result__item">Tickets: <span class="book-result__count booking-ticket">3</span>
                        </li>

                        <li class="book-result__item">Total: <span class="book-result__count booking-cost">$60</span>
                        </li>
                    </ul>
                    <!-- 
                    <h2 class="page-heading">Choose payment method</h2>
                    <div class="payment">
                        <a href="#" class="payment__item">
                            <img alt='' src="images/payment/pay1.png">
                        </a>
                        <a href="#" class="payment__item">
                            <img alt='' src="images/payment/pay2.png">
                        </a>
                        <a href="#" class="payment__item">
                            <img alt='' src="images/payment/pay3.png">
                        </a>
                        <a href="#" class="payment__item">
                            <img alt='' src="images/payment/pay4.png">
                        </a>
                        <a href="#" class="payment__item">
                            <img alt='' src="images/payment/pay5.png">
                        </a>
                        <a href="#" class="payment__item">
                            <img alt='' src="images/payment/pay6.png">
                        </a>
                        <a href="#" class="payment__item">
                            <img alt='' src="images/payment/pay7.png">
                        </a>
                    </div> -->

                    <h2 class="page-heading">Contact information</h2>

                    <form id='contact-info' method='post' novalidate="" class="form contact-info">
                        <div class="contact-info__field contact-info__field-mail">
                            <input disabled type='email' name='user-mail' placeholder='Your email' class="form__mail">
                        </div>
                        <div class="contact-info__field contact-info__field-tel">
                            <input disabled type='tel' name='user-tel' placeholder='Phone number' class="form__mail">
                        </div>
                    </form>


                </div>

                <div class="order">
                    <a id="purchase" href="book-final.html" class="btn btn-md btn--warning btn--wide"
                        onclick="">purchase</a>
                </div>

            </div>

        </section>


        <div class="clearfix"></div>

        <div class="booking-pagination">
            <a href="book2.html" class="booking-pagination__prev">
                <p class="arrow__text arrow--prev">prev step</p>
                <span class="arrow__info">choose a sit</span>
            </a>
            <a href="#" class="booking-pagination__next hide--arrow">
                <p class="arrow__text arrow--next">next step</p>
                <span class="arrow__info"></span>
            </a>
        </div>

        <div class="clearfix"></div>

        <footer class="footer-wrapper">
            <section class="container">
                <div class="col-xs-4 col-md-2 footer-nav">
                    <ul class="nav-link">
                        <li><a href="movie-list-left.html" class="nav-link__item">Phạm Việt Trung</a></li>
                        <li><a href="trailer.html" class="nav-link__item">Đinh Anh Tiến</a></li>
                        <li><a href="rates-left.html" class="nav-link__item">Trần Trọng Nghĩa</a></li>
                    </ul>
                </div>
                <div class="col-xs-4 col-md-2 footer-nav">
                    <ul class="nav-link">
                        <li><a href="coming-soon.html" class="nav-link__item">Vũ Huy Đức</a></li>

                    </ul>
                </div>
                <div class="col-xs-12 col-md-6">
                    <div class="footer-info">
                        <p class="heading-special--small">A.Movie<br><span class="title-edition">in the social
                                media</span></p>

                        <div class="social">
                            <a href='#' class="social__variant fa fa-facebook"></a>
                            <a href='#' class="social__variant fa fa-twitter"></a>
                            <a href='#' class="social__variant fa fa-vk"></a>
                            <a href='#' class="social__variant fa fa-instagram"></a>
                            <a href='#' class="social__variant fa fa-tumblr"></a>
                            <a href='#' class="social__variant fa fa-pinterest"></a>
                        </div>

                        <div class="clearfix"></div>
                        <p class="copy">&copy; Nhóm 10, Đề tài: Quản lý đặt vé xem phim</p>
                    </div>
                </div>
            </section>
        </footer>
    </div>

    <!-- open/close -->
    <div class="overlay overlay-hugeinc">

        <section class="container">

            <div class="col-sm-4 col-sm-offset-4">
                <button type="button" class="overlay-close">Close</button>
                <form id="login-form" class="login" method='get' novalidate=''>
                    <p class="login__title">sign in <br><span class="login-edition">welcome to A.Movie</span></p>

                    <div class="social social--colored">
                        <a href='#' class="social__variant fa fa-facebook"></a>
                        <a href='#' class="social__variant fa fa-twitter"></a>
                        <a href='#' class="social__variant fa fa-tumblr"></a>
                    </div>

                    <p class="login__tracker">or</p>

                    <div class="field-wrap">
                        <input type='email' placeholder='Email' name='user-email' class="login__input">
                        <input type='password' placeholder='Password' name='user-password' class="login__input">

                        <input type='checkbox' id='#informed' class='login__check styled'>
                        <label for='#informed' class='login__check-info'>remember me</label>
                    </div>

                    <div class="login__control">
                        <button type='submit' class="btn btn-md btn--warning btn--wider">sign in</button>
                        <a href="#" class="login__tracker form__tracker">Forgot password?</a>
                    </div>
                </form>
            </div>

        </section>
    </div>

    <!-- JavaScript-->
    <!-- jQuery 1.9.1-->
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
    <script>window.jQuery || document.write('<script src="js/external/jquery-1.10.1.min.js"><\/script>')</script>
    <!-- Migrate -->
    <script src="js/external/jquery-migrate-1.2.1.min.js"></script>
    <!-- Bootstrap 3-->
    <script src="http://netdna.bootstrapcdn.com/bootstrap/3.0.2/js/bootstrap.min.js"></script>

    <!-- Mobile menu -->
    <script src="js/jquery.mobile.menu.js"></script>
    <!-- Select -->
    <script src="js/external/jquery.selectbox-0.2.min.js"></script>

    <!-- Form element -->
    <script src="js/external/form-element.js"></script>
    <!-- Form validation -->
    <script src="js/form.js"></script>

    <!-- Custom -->
    <script src="js/custom.js"></script>
    <script>
        // Lấy giá trị từ local storage
        var selectedPlaces = JSON.parse(localStorage.getItem('selectedPlaces'));
        var sumMoney = localStorage.getItem('sumMoney');

        // Xây dựng chuỗi từ mảng
        var formattedPlaces = selectedPlaces.join(', ');

        // Cập nhật giá trị trong mã HTML
        document.querySelector('.booking-ticket').textContent = formattedPlaces;
        document.querySelector('.booking-cost').textContent = sumMoney + " VNĐ";
    </script>
    <script type="text/javascript">
        $(document).ready(function () {
            getPhongbyPhimAndKtg();
            handleBuyTicket();

            const maThanhVien = localStorage.getItem("maThanhVien");
            const tenThanhVien = localStorage.getItem("tenThanhVien");
            const mainContentDiv = document.getElementById("username");
            if (!maThanhVien) {
                // Người dùng chưa đăng nhập
                console.log("Vui lòng đăng nhập.");
                mainContentDiv.innerHTML = `<a href="#" class="btn btn--sign btn--singin">Đăng ký / Đăng nhập</a>
                                <ul class="auth__function">
                                    <li><a href="signup.php" class="auth__function-item">Đăng ký</a></li>
                                    <li><a href="login.php" class="auth__function-item">Đăng nhập</a></li>
                                </ul>`;
            } else {
                // Người dùng đã đăng nhập
                console.log(`Xin chào, ${tenThanhVien}!`);
                mainContentDiv.innerHTML = `<a href="#" class="btn btn--sign btn--singin"> ${tenThanhVien} </a>
                                <ul class="auth__function">
                                    <li><a href="logout.php" class="auth__function-item">Đăng xuất</a></li>
                                </ul>`;
            }
            $("#search-btn").click(function (event) {
                event.preventDefault();
                let val = $("#search-input").val();
                window.location.href = `index.html?q=${val}`;
            });
        });

        function getPhongbyPhimAndKtg() {
            let url =
                `http://localhost/movie_booking_project_team2/api/v1/phong/getPhongbyPhimAndKtg?maPhim=${localStorage.getItem("maPhim")}&maKTG=${localStorage.getItem("selectedTime")}`;
            $.ajax({
                url: url,
                success: function (result) {
                    let html = '';
                    $.each(result, function (index, item) {

                        html += ` <div class="checkout-wrapper">
                    <h2 class="page-heading">Movie</h2>
                        <ul class="book-result">
                            <li class="book-result__item">Movie: <span class="book-result__count">${item.TenPhim}</span>
                            </li>
                            <li class="book-result__item">Ngày chiếu: <span
                                    class="book-result__count">${item.NgayChieu}</span></li>
                            <li class="book-result__item">Suất chiếu: <span class="book-result__count ">${item.GioChieu}</span>
                            </li>
                            <li class="book-result__item">Phòng chiếu: <span class="book-result__count ">${item.TenPhong}</span>
                            </li>
                        </ul>
                    </div>`;
                    });
                    $("#movie_phong").html(html);

                },

            });

        }

        function handleBuyTicket() {
            const buyElem = document.querySelector("#purchase");
            buyElem.addEventListener("click", async function (event) {
                event.preventDefault();
                const url = `http://localhost/movie_booking_project_team2/api/v1/tickets/createTicket`;
                const maKTG = localStorage.getItem("selectedTime");
                const dsGheDat = localStorage.getItem("selectedPlaces");
                const maPhim = localStorage.getItem("maPhim");
                const maThanhVien = localStorage.getItem("maThanhVien");
                const maPhong = localStorage.getItem("maPhong");
                const dsGheDatArray = JSON.parse(dsGheDat);
                const data = {
                    maKTG,
                    dsGheDatArray,
                    maPhim,
                    maPhong,
                    maThanhVien,
                }

                const json = JSON.stringify(data);

                const res = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    body: json
                });

                const result = await res.json();
                console.log(result);
                if (result) {
                    alert("Đặt vé thành công");
                    setTimeout(() => {
                        window.location.href = "book-final.html";
                    }, 1000)
                }

            })
        }
    </script>

</body>

</html>